<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Environmental Misinformation Detection</title>
    <link rel="stylesheet" href="/static/style.css">
</head>

<body>
    <div class="container">

        <!-- Dark Mode Toggle -->
        <button id="toggleDark">Dark Mode</button>

        <h1>Environmental Claims Classifier</h1>

        <div class="explanation">
            <p>
                This tool highlights environmental claims that <strong>may require revision</strong>.
                It uses a machine-learning model trained on labeled environmental claims.
            </p>
            <p>
                The model outputs probabilities for each label. A claim is <em>flagged</em> when the
                probability of being <strong>likely false</strong> exceeds a predefined threshold.
                This conservative rule prioritizes avoiding harmful false negatives.
            </p>

            <p class="disclaimer">
                This tool is a guide, not a fact-checker. Always verify claims using
                trusted sources.
            </p>
        </div>

        <textarea id="claimInput" placeholder="Enter a claim such as: Climate change intensify typhoons.'"></textarea>
        <label for="modelSelect" class="subtitle" style="margin-top:15px; display:block;">
            Select decision:
        </label>

        <select id="modelSelect" style="padding:10px; width:100%; border-radius:10px; margin-bottom:15px;">
            <option value="thresholded">Thresholded</option>
        </select>
        <button id="predictBtn">Run Analysis</button>

        <div id="loader" class="loader hidden"></div>

        <div id="results" class="results hidden"></div>

    </div>

<script>
/* ---------------- DARK MODE ---------------- */
document.getElementById("toggleDark").onclick = () => {
    document.documentElement.classList.toggle("dark");
};

/* ---------------- PREDICTION LOGIC ---------------- */
document.getElementById("predictBtn").onclick = async () => {
    const text = document.getElementById("claimInput").value.trim();
    const model = document.getElementById("modelSelect").value; 

    if (!text) return;

    document.getElementById("results").classList.add("hidden");
    document.getElementById("loader").classList.remove("hidden");

    const response = await fetch("/predict_all", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, model })   // send model to backend
    });

    const data = await response.json();

    document.getElementById("loader").classList.add("hidden");

    const container = document.getElementById("results");
    container.innerHTML = "";

    /* data.results: [{model, pred_label, confidence, probabilities, threshold}] */
    data.results.forEach(model => {
        const card = document.createElement("div");
        card.className = "model-card";

        // const title = document.createElement("h2");
        // title.textContent = model.model;
        // card.appendChild(title);

        if (model.threshold !== null && model.threshold !== undefined) {
            const pFalse = model.probabilities["LIKELY_FALSE"];
            const threshold = model.threshold;

            const status = document.createElement("p");
            status.className = "status";

            if (pFalse >= threshold) {
                status.innerHTML = `
                    <strong>Status:</strong>
                    ⚠️ Flagged as potentially false
                `;
                status.classList.add("flagged");
            } else {
                status.innerHTML = `
                    <strong>Status:</strong>
                    ✅ Not flagged
                `;
                status.classList.add("not-flagged");
            }

            const thr = document.createElement("p");
            thr.innerHTML = `
                <strong>Flagging threshold:</strong> ${threshold}
            `;

            card.appendChild(thr);
            card.appendChild(status);
        }

        const probsDiv = document.createElement("div");
        probsDiv.className = "prob-list";

        const probsTitle = document.createElement("p");
        probsTitle.innerHTML = `<strong>Model probabilities:</strong>`;
        card.appendChild(probsTitle);

        Object.entries(model.probabilities).forEach(([label, prob]) => {
            const bar = `
                <div class="prob-item">
                    <span>${label} — ${prob.toFixed(3)}</span>
                    <div class="bar-container">
                        <div class="bar" style="width:${prob * 100}%"></div>
                    </div>
                </div>`;
            probsDiv.innerHTML += bar;
        });

        card.appendChild(probsDiv);
        container.appendChild(card);
    });

    container.classList.remove("hidden");
};
</script>

</body>
</html>